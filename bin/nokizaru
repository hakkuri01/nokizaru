#!/usr/bin/env ruby
# frozen_string_literal: true

# Set up signal handling before requiring gems so shutdown behavior stays predictable
# Install traps before Bundler can register its own handlers
require_relative '../lib/nokizaru/interrupt_state'
require_relative '../lib/nokizaru/cli_argv'

$stdout.sync = true # Ensure output is flushed immediately

# Set up clean interrupt handling for Ctrl+C
Signal.trap('INT') do
  if Nokizaru::InterruptState.interrupted?
    # Second Ctrl+C = hard exit
    puts "\n\e[31m⟦✘⟧ Force quit\e[0m"
    exit!(1)
  else
    # First Ctrl+C = graceful shutdown
    Nokizaru::InterruptState.interrupt!
    puts "\n\e[33m⟦✘⟧ Scan interrupted by user\e[0m"
    puts "\e[2m    Press Ctrl+C again to force quit\e[0m"

    # Kill all threads except main
    Thread.list.each do |thread|
      thread.exit unless thread == Thread.main
    end

    puts "\e[2mCleaning up...\e[0m"
    exit(130)
  end
end

# Handle SIGTERM
Signal.trap('TERM') do
  puts "\n\e[33m⟦✘⟧ Received termination signal\e[0m"
  Thread.list.each { |thread| thread.exit unless thread == Thread.main }
  exit(143)
end

# Run the main CLI entrypoint with guarded error handling
begin
  # Normalize arguments before Thor processes them
  Nokizaru::CLIArgv.normalize_help_invocation!(ARGV)
  Nokizaru::CLIArgv.normalize_argv!(ARGV)

  # Load the application
  require_relative '../lib/nokizaru'

  # Start the CLI
  Nokizaru::CLI.start(ARGV)
rescue Interrupt
  # Catch any Interrupt that bubbles up (shouldn't happen with trap above)
  puts "\n\e[2mExited.\e[0m" unless Nokizaru::InterruptState.interrupted?
  exit(130)
rescue SystemExit
  # Allow normal exits to propagate
  raise
rescue StandardError => e
  # Catch any unexpected errors and display them cleanly
  puts "\n\e[31m⟦✘⟧ Unexpected error: #{e.class}\e[0m"
  puts "\e[2m#{e.message}\e[0m"

  # Show backtrace only if in development/debug mode
  if ENV['NOKIZARU_DEBUG'] || ENV['DEBUG']
    puts "\n\e[2mBacktrace:\e[0m"
    puts e.backtrace.map { |line| "  #{line}" }.join("\n")
  else
    puts "\e[2mRun with NOKIZARU_DEBUG=1 for full backtrace\e[0m"
  end

  exit(1)
end
